From b680ee54032549388cf5d7b9a2d076241c2f6f10 Mon Sep 17 00:00:00 2001
From: xshu <xshu@google.com>
Date: Tue, 22 Dec 2020 19:12:32 -0800
Subject: [PATCH] [OF6Q-572]:Security Patch 2021-03-01 ANDROID-175124730

[porting]

Fix UAF problem in wificond

This is a security upstream patch.

Bug: 175124730
Test: Verified the crash in rvc-qpr-dev using poc.cpp and test
instructions provided in the bug and verified the fix works.


CVE-2021-0392

Change-Id: Iabccac7f9fbed9d856bee41c5443e3b8479c3e62
Merged-In: Iabccac7f9fbed9d856bee41c5443e3b8479c3e62
(cherry picked from commit fae786e5bbc4adfbe5239b3bb3df0cd6122283a6)
(cherry picked from commit 67d87a0e7e2213959f505e6a355c50079b062037)
---
 main.cpp | 4 ++--
 1 file changed, 2 insertions(+), 2 deletions(-)

diff --git a/main.cpp b/main.cpp
index 4e8586f..43c592d 100644
--- a/main.cpp
+++ b/main.cpp
@@ -140,11 +140,11 @@ int main(int argc, char** argv) {
   android::wificond::NetlinkUtils netlink_utils(&netlink_manager);
   android::wificond::ScanUtils scan_utils(&netlink_manager);
 
-  unique_ptr<android::wificond::Server> server(new android::wificond::Server(
+  android::sp<android::wificond::Server> server(new android::wificond::Server(
       unique_ptr<InterfaceTool>(new InterfaceTool),
       &netlink_utils,
       &scan_utils));
-  RegisterServiceOrCrash(server.get());
+  RegisterServiceOrCrash(server);
 
   event_dispatcher->Poll();
   LOG(INFO) << "wificond is about to exit";
-- 
2.30.0.280.ga3ce27912f-goog

