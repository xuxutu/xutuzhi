From d6f2e6d214d5050aad0a332d73e573db94d218aa Mon Sep 17 00:00:00 2001
From: Rahul Sharma <rahsha@codeaurora.org>
Date: Mon, 14 Sep 2020 19:53:03 +0530
Subject: disp: msm: sde: add event to event_list after register is successful

Add event to event_list after msm_register_event is successful to avoid
use-after-free vulnerability.

Change-Id: I144ae82c657c1e2cf16608c0e8768b12a7d27974
Signed-off-by: Rahul Sharma <rahsha@codeaurora.org>
---
 msm/msm_drv.c | 10 +++++-----
 1 file changed, 5 insertions(+), 5 deletions(-)

diff --git a/msm/msm_drv.c b/msm/msm_drv.c
index 464e041..35172da 100644
--- a/msm/msm_drv.c
+++ b/msm/msm_drv.c
@@ -1264,11 +1264,6 @@ static int msm_ioctl_register_event(struct drm_device *dev, void *data,
 	 * calls add to client list and return.
 	 */
 	count = msm_event_client_count(dev, req_event, false);
-	/* Add current client to list */
-	spin_lock_irqsave(&dev->event_lock, flag);
-	list_add_tail(&client->base.link, &priv->client_event_list);
-	spin_unlock_irqrestore(&dev->event_lock, flag);
-
 	if (count)
 		return 0;
 
@@ -1281,6 +1276,11 @@ static int msm_ioctl_register_event(struct drm_device *dev, void *data,
 		list_del(&client->base.link);
 		spin_unlock_irqrestore(&dev->event_lock, flag);
 		kfree(client);
+	} else {
+		/* Add current client to list */
+		spin_lock_irqsave(&dev->event_lock, flag);
+		list_add_tail(&client->base.link, &priv->client_event_list);
+		spin_unlock_irqrestore(&dev->event_lock, flag);
 	}
 	return ret;
 }
-- 
cgit v1.1

