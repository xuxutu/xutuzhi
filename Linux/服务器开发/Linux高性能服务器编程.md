# Linux高性能服务器编程

## 前言

### 大师级别的书

​	整本书只关注于一个问题，而且对每个技术细节的描述都精雕细琢。最关键的是，我们在阅读这些经典书籍时，似乎实在用心与一位编程高手交流。这绝对是一种享受。



## 第一章 TCP/IP协议族

### 1.1 TCP/IP协议族体系结构以及主要协议

​	**TCP/IP协议族是一个四层协议系统**。上层协议使用下层协议提供的服务。

![image-20210603153452436](Linux高性能服务器编程.assets/image-20210603153452436.png)	



#### 1.1.1 数据链路层

​	**数据链路层**实现了**网卡接口**的**网络驱动程序**，以处理数据在物理媒介（以太网、令牌环）上的传输。不同的物理网络有不同的电气特性，网卡驱动程序隐藏了这些细节，为上层协议提供一个统一的接口。

​	数据链路层常用的协议是ARP协议（Address reslove Protocol，地址解析协议 ）和RARP协议（Rerverse Address reslove Protocol，逆地址解析协议 ）。**它们实现了IP地址与机器物理地址（MAC地址）的相互转换。**

​	网络层通过IP地址寻找一台机器，而数据链路层通过mac地址寻找一台机器，因此网络层必须先将IP地址转为物理地址，才能使用数据链路层提供的服务，这就**是ARP协议的用途**。RARP协议仅用于网络上的某些无盘工作站。以内缺乏存储设备，无盘工作站无法记住自己的IP地址，但是它们可以利用网卡上的物理地址来向网络管理者（服务器或网络管理软件）查询自身的IP地址。运行RARP的网络管理者通常存有该网络上所有机器的物理地址到IP地址的映射，



#### 1.1.2 网络层

​	**网络层实现数据包的选路和转发。**WAN（Wide Area Network， 广域网）通常使用众多分级的路由器来连接分散的主机或LAN（Local Area Network， 局域网）因此通信的两台主机一般不是直接相连的，而是通过多个中间节点（路由器）连接的。**网络层的任务就是选择这些中间节点，以确定两台机器之间的通信路径**。**同时网络层对上层协议隐藏了网络拓扑连接的细节，使得传输层和上层应用程序来看，两台机器是直接向连的**，

​	网络层最核心的协议是**IP协议**（Internet Protocol，因特网协议）。IP协议根据数据包的目的IP地址来决定如何投递它。如果数据包不能直接发给目标主机，那么IP协议就为它寻找一个合适的下一跳（next hop）路由器，并将数据交付给该路由器来转发。多次重复这一过程，数据最终达到目标主机，或者由于发送失败而被丢弃。可见，**IP协议通过逐跳的（hop by hop）方式来来确定通信路径**。

​	网络层的另一个重要的协议是**ICMP协议**（Internet Control message Protocol，因特网控制报文协议）。它是IP协议的重要补充，主要用于检测网络连接。ICMP使用的报文格式如图：

![image-20210603161554266](Linux高性能服务器编程.assets/image-20210603161554266.png)

上图，**八位类型字段**用于区分报文类型。它将ICMP报文分为两大类：一类是差错报文，这类报文主要是用来回应网络错误，比如目标不可到达（类型值为3），和重定向（类型值为5）;另一类是查询报文，这类报文用来查询网络信息，比如ping程序就是使用ICMP报文查看目标是否可到达的（类型值为8）。有的ICMP还使用**八位代码字段**来进一步细分不同的条件。比如重定向报文使用代码值0表示对网络重定向，代码值为1代表对主机重定向。ICMP报文使用16为校验和字段对整个报文（包括头部和内容部分）进行循环冗余校验（Cyclik Redundancy Check，CRC），以检验报文在传输过程中是否损坏。不同的ICMP报文类型具有不同的正文内容。

需要指出的是，ICMP协议并不属于严格意义上的网络层协议，因为它使用处于同一层的IP协议提供的服务（一般来说上层协议使用下层协议提供的服务）。

