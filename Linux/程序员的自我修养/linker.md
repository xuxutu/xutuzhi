## 第三章 目标文件里有什么

![image-20210813172730781](linker.assets/image-20210813172730781.png)	

### 3.3 测试程序代码

![image-20210816132605278](linker.assets/image-20210816132605278.png)	

1.objdump -h 打印各个段的基本信息

![image-20210816125605044](linker.assets/image-20210816125605044.png)	



CONTENTS表示该段在文件中存在



2.size查看

![](linker.assets/image-20210816131038549.png)	



#### 3.3.1 代码段

![image-20210816131539540](linker.assets/image-20210816131539540.png)	

![image-20210816131600124](linker.assets/image-20210816131600124.png)	



#### 3.3.2 数据段和只读数据段

![image-20210816132530927](linker.assets/image-20210816132530927.png)	

​	

```
0x54 = 84;
0x55 = 85
```

```
只读数据：
% =0x25
d  =0x64
\n =0x0A
\0 =0x00
```

“.rodta“段存放的时只读数据，一般是程序里面的**只读变量**（如**const**修饰的变量）和 **字符串常量**。

单独设.r**odata段有很多好处**，不光是在语义上支持了C++的const关键字，而且操作系统在加载的时后可以将“.rodata“段的属性映射成只读，这样对于这个段的任何修改操作都会作为非法操作处理，保证了程序的安全性。另外在某些嵌入式平台下，有些存储区域是采只读存储器的，如ROM，这样将“.rotada”段放在该存储区域中，就可以保证访问存储器的正确性。

另外值得一提的是，有**时候编译器会把字符串常量放到“.data”段中.将.c改为.cpp可验证**



#### 3.3.3 BSS段

.bss存放的是**未初始化**的**局部静态变量和全局变量**

有些编译器会将全局的为未始化变量存放在目标文件.bss段，有些则不存放，只是预留一个为定义的全局变量符号，等到最终链接成可执行文件的时候再在.bss段分配空间。

**注意下边全局的已初始化的变量的存放位值**

```
static int x1 = 0; .bss
static int x2 = 1; .data
```



#### 3.3.4 其他段

![image-20210817130225723](linker.assets/image-20210817130225723.png)	

1.我们可以自己插入一个段比如music，但是不能以.开头

2.一个ELF文件可以有几个相同段名的段，比如.text

3.一些保留的段是历史遗留问题造成的



#### 3.3.5 自定义段

![image-20210817135744565](linker.assets/image-20210817135744565.png)		



#### 3.3.6 代码指定段

![image-20210817135843697](linker.assets/image-20210817135843697.png)	



### 3.4 ELF文件结构描述

![image-20210817140558198](linker.assets/image-20210817140558198.png)	

ELF文件头描述了整个文件的基本属性,紧接着是ELF文件的各个段。其中ELF为文件中与段有关的最重要的结构是段表，该表描述了与ELF文件包含的所有段的信息。

#### 3.4.1 文件头

![image-20210817143719697](linker.assets/image-20210817143719697.png)	



ELF文件头结构及相关常数被定义在“/usr/include/elf.h”里。32位、64位的头部结构分别为Elf32_Ehdr、Elf64_Ehdr.



Elf32_Ehdr:

![image-20210817144755447](linker.assets/image-20210817144755447.png)	



##### 1)ELF魔数

用来标识ELF文件的平台属性

![image-20210817145925965](linker.assets/image-20210817145925965.png)	

前四个字节是标识码

```
0x7f= DEL
0x45= 'E'
0x4c= 'L'
0x46= 'F'
```

操作系统在加载可执行文件的时候会确认魔数是否会正确，如果不正确会拒绝加载

接下来一个字节标识类型

```
0x01 表示32位
0x02 表示64位
```

第6个字节表示字节序

```
0x01 小端
```

第7个字节表示主版本号

```
0x01
```

后边的9个字节未定义，为0

##### 2)e_type

表示ELF文件类型

![image-20210817160444471](linker.assets/image-20210817160444471.png)	

##### 3)机器类型

e_machine 表示该ELF文件的平台属性，

![image-20210817160856267](linker.assets/image-20210817160856267.png)	

